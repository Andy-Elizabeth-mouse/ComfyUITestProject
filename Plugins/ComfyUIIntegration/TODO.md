# ComfyUI Integration Plugin - 待办事项列表

这是根据当前代码库分析得出的开发待办事项列表。

## 🚀 核心功能

- [x] **实现真实的图像下载和处理**
  - 在 `OnQueueStatusChecked` 中，当生成完成后，需要调用 `/view` API 下载生成的图像，而不是创建占位符纹理。
  - 完善 `OnImageDownloaded` 回调逻辑，并确保它被正确调用。
  - `CreateTextureFromImageData` 需要支持更多图像格式（如JPEG），并进行错误处理。

- [x] **实现资产保存功能**
  - 添加将生成的 `UTexture2D` 保存到项目内容浏览器（Content Browser）的功能。
  - 实现 "Save" 和 "Save As..." 逻辑。
  - 允许用户指定保存路径和文件名。

- [x] **完善错误处理机制**
  - 在HTTP请求失败时，向用户界面提供更明确的错误信息（例如，连接失败、服务器错误、工作流无效等）。
  - 增加请求重试机制。

- [ ] **增强UI反馈**
  - 在 `PollGenerationStatus` 中，可以解析更详细的队列状态，为UI提供进度条更新。
  - 在生成过程中禁用UI控件，以防止重复操作。
  - 显示明确的“生成中...”、“已完成”、“失败”等状态。

##  workflow 扩展

- [ ] **实现3D和纹理生成工作流**
  - 在 `EComfyUIWorkflowType` 中已经定义了 `TextTo3D`, `ImageTo3D`, `TextureGeneration`。
  - 需要在 `InitializeWorkflowConfigs` 或通过JSON配置文件为这些类型添加相应的工作流模板。
  - 实现处理3D模型数据（如glTF, obj）和纹理数据的逻辑。

- [ ] **完善图生图（Image-to-Image）工作流**
  - 当前的 `BuildWorkflowJson` 没有处理输入图像的逻辑。
  - 需要添加上传本地图像到ComfyUI服务器的功能（使用 `/upload/image` API）。
  - 在构建JSON时，将上传的图像文件名填入 `LoadImage` 节点。

## 💻 代码质量和重构

- [ ] **重构工作流JSON构建逻辑**
  - `BuildWorkflowJson` 和 `BuildCustomWorkflowJson` 存在大量重复代码，可以合并为一个通用函数。
  - 使用更健壮的JSON操作方法来替换 `FString::Replace`，以避免在提示词中包含特殊字符时出现问题。可以直接操作 `TSharedPtr<FJsonObject>` 来修改节点值。

- [ ] **优化配置管理**
  - 实现用户设置（如服务器URL）的持久化保存和加载。
  - 提供一个UI界面来管理和编辑自定义工作流模板。

- [ ] **添加代码注释和文档**
  - 为公共头文件（.h）中的函数和类添加详细的Doxygen风格注释。
  - 清理和统一代码中的日志记录（`UE_LOG`）。

## 🧪 测试

- [ ] **创建单元测试**
  - 为 `UComfyUIClient` 的关键逻辑（如JSON构建）编写单元测试。
- [ ] **创建集成测试**
  - 编写自动化测试来验证与真实ComfyUI服务器的完整通信流程。

## 🎨 UI 相关

- [ ] **实现预览功能**
  - `OnPreviewClicked` 当前是空的。可以实现一个功能，比如在一个新的编辑器窗口中打开生成的纹理，以便更详细地查看。

- [ ] **完善工作流导入功能**
  - `OnImportWorkflowClicked` 只是将文件复制到 `Templates` 目录。可以增加对导入的JSON文件进行验证，确保其是有效的ComfyUI工作流格式。
  - 考虑支持从URL导入工作流。

- [ ] **UI状态管理**
  - 在生成过程中，除了禁用“生成”按钮，还应禁用其他可能冲突的控件（如工作流选择、提示词输入等）。
  - 提供一个“取消”按钮来中断正在进行的生成任务。

- [ ] **图生图UI**
  - 当选择“Image to Image”工作流时，需要显示一个用于选择输入图像的UI元素（例如，一个图像槽或一个文件选择按钮）。
  - 实现将用户选择的图像上传到ComfyUI服务器的逻辑。

## ✨ 视觉和样式

- [ ] **替换占位符图标**
  - 在 `ComfyUIIntegrationStyle.cpp` 中，菜单按钮的图标当前是 `PlaceholderButtonIcon`。
  - 需要设计一个正式的插件图标（SVG格式），并将其添加到 `Resources` 目录中。
  - 考虑设计一套完整的图标集，包括不同工作流类型的图标。

## 🔧 模块和架构

- [ ] **增强插件生命周期管理**
  - 在 `FComfyUIIntegrationModule::StartupModule()` 中，需要检查依赖模块是否正确加载。
  - 在 `ShutdownModule()` 中，需要确保所有资源正确释放，包括正在进行的HTTP请求。
  - 考虑添加插件配置的验证和初始化逻辑。

- [ ] **Tab管理优化**
  - `OnSpawnComfyUITab` 每次都创建新的 `SComfyUIWidget` 实例，可能导致状态丢失。
  - 考虑实现单例模式，或者在Tab关闭时保存状态。
  - 添加Tab的最小尺寸和默认尺寸设置。

## ⌨️ 命令和快捷键

- [ ] **扩展命令系统**
  - 当前只有一个 `OpenPluginWindow` 命令。可以添加更多有用的命令：
    - 快速生成（使用上次的设置）
    - 清除当前预览
    - 打开设置对话框
    - 导入/导出工作流快捷命令
  
- [ ] **添加键盘快捷键**
  - 为常用功能添加快捷键，如 `Ctrl+Shift+C` 打开ComfyUI窗口。
  - 在Widget内部添加快捷键支持（如 `Ctrl+Enter` 开始生成）。

## 📡 事件和委托系统

- [ ] **扩展委托系统**
  - 当前只有 `FOnImageGenerated` 委托。可以添加更多委托来改善反馈：
    - `FOnGenerationStarted` - 生成开始时触发
    - `FOnGenerationProgress` - 生成进度更新时触发  
    - `FOnServerStatusChanged` - 服务器连接状态变化时触发
    - `FOnWorkflowLoaded` - 工作流加载完成时触发
  
- [ ] **改进错误处理委托**
  - 添加详细的错误信息委托，包括错误类型、错误代码、可能的解决方案等。
  - 支持多语言错误消息。

## 🏗️ 构建和依赖

- [ ] **优化模块依赖**
  - 检查 `ComfyUIIntegration.Build.cs` 中的依赖是否都必要，移除未使用的模块依赖。
  - 考虑添加条件依赖，如只在编辑器模式下加载某些模块。
  - 添加平台特定的依赖管理。

- [ ] **添加配置选项**
  - 在构建脚本中添加可配置的编译选项（如是否包含调试功能）。
  - 支持不同的构建配置（Development, Shipping等）。

## 📁 项目结构和组织

- [ ] **改进文件组织**
  - 考虑将UI相关的类移到单独的UI子目录中。
  - 为网络通信、工作流管理、资产处理等功能创建专门的子模块。
  - 添加更详细的代码文档和注释。

## 🚀 高级功能和扩展

- [ ] **插件设置系统**
  - 实现插件设置页面，集成到UE编辑器的项目设置中。
  - 支持用户自定义默认参数、服务器列表、工作流收藏夹等。
  - 添加设置导入/导出功能。

- [ ] **批处理和自动化**
  - 实现批量图像生成功能。
  - 添加命令行接口支持，允许通过脚本调用。
  - 支持定时任务和工作流调度。

- [ ] **扩展性和插件生态**
  - 设计插件扩展API，允许第三方开发者添加自定义工作流类型。
  - 实现工作流市场或共享平台的基础架构。
  - 支持插件更新和版本管理。

## 🔍 监控和诊断

- [ ] **性能监控**
  - 添加性能指标收集（生成时间、内存使用、网络延迟等）。
  - 实现性能分析和优化建议系统。

- [ ] **调试和诊断工具**
  - 添加网络请求日志记录和查看器。
  - 实现工作流JSON验证和调试工具。
  - 提供系统信息和兼容性检查功能。

---

## 📋 总结

当前项目已经实现了基础的ComfyUI集成功能，包括：
- ✅ 完整的UE5插件架构
- ✅ 基础的HTTP通信
- ✅ Slate UI界面
- ✅ 工作流模板系统

主要待完成的工作集中在：
1. **核心功能完善**：真实图像处理、资产保存、3D工作流
2. **用户体验优化**：进度反馈、错误处理、UI状态管理  
3. **高级功能**：批处理、设置系统、扩展性

建议按优先级逐步实现这些功能，先完成核心功能，再扩展高级特性。
